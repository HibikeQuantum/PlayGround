📕 데브옵스 핸드북

#Book/Doing

## 1부 소개

* 핵심 키워드: 전달을 가속화하는 흐름, 보다 안전한 시스템을 만드는 피드백, 지속적인 학습 및 실험

* 배치: 일괄적, 비실시간적 작업. OLTP online transaction

## 첫번째 원칙, 흐름

**작업흐름에서 신속하게 좌측에서 우측으로 옮기기 위한 수단**

* 업무시각화 - 칸반

* WIP 제한

	* 기하학 도형의 배치같은 실험에서도 멀티태스킹은 작업속도를 떨어틀였다. 실제 기술적 작업에 미치는 영향은 이것보다 더 크다.

	* “시작하지 말고 끝내라”

	* 칸반보드 컬럼에 둘 수 있는 태스크의 상한을 두면 무엇이 문제인지 파악하기 쉽다. 실제로 인터럽트를 할 수 없어 대기를 할때 손실이 눈에 보이기 때문이다.

* 배치작업의 크기 줄이기

	* 대규모 배치작업에 에러가 발생한 경우를 생각해보자 여파는 배포대상에 비례한다. 배치를 작게 만들자.

* 핸드오프 횟수 줄이기 (이관작업 - 다른 사람한테 업무전달)

	* 핸드오프할때 마다 생기는 컨텍스트의 손실이 비용이다

* 제약조건을 지속적으로 확인하고 향상시키기

	* 제약조건에 대한 확인없이 이뤄진 개선은 환상이다

	* on demand에 대응할 수 있는 환경, 배포, 테스트, 과도한 아키텍쳐 대신 엔지니어의 자율적이고 느슨한 결합.

	* 성과가 높은 사람은 개발자의 생산성 극대화가 목표라고 이야기한다.

* 가치흐름에서 어려움과 낭비제거

	* 낭비: 미완성 작업, 가치를 제공하지 않는 추가적 작업, 금도금(gold plating), 작업전환, 대기, 동작(워크센터 to 워크센터로 이동할때 비용), 결함, 비표준 및 수동 작업(모든 작업은 자동화되고 셀프서비스화 되어야한다), 용단(heroics): 불합리하게 처리하는 일 (새벽의 장애, 수백 개의 작업 티켓 생성)

## 두번째 원칙, 피드백 원칙

**작업흐름의 우측에서 좌측으로 신속하게 피드백 하기 위한 챕터**

* 처벌과 비난의 기회가 아닌 학습의 기회로 만들자

* 복잡한 시스템에서 안전하게 작업하기

	* 이런 시스템의 특징: 상호 연결성이 높아 컴포넌트를 분리하기 힘들다. 문제는 취약한 경로로 빠르게 퍼져나간다. 예측이 어렵기 때문에 정적인 체크리스트나 모범 사례가 도움이 안된다.

	* 완벽한 시스템은 만들 수 없지만 안전한 시스템은 만들 수 있다. 1) 복잡한 작업이 관리된다. 2) 문제점을 해결하면 새로운 지식을 구축한다. 3) 새로운 지역적 지식을 전사적으로 활용한다 4) 이런 유형의 역량을 성장시키는 리더를 만든다.

* 문제를 발생 시점에 확인하기

	* 피드백의 빈도가 품질, 테스트는 피드백지 한가지 종류일뿐이다. 고객의 요구, 제품의 의도와 구현 사이에서 계속 피드백이 필요하다.

* 지식 축적을 위한 문제의 스워밍과 해결

	* 도요타의 안돈코드, 정해진 시간을 초과하면 모두가 모인다. 문제가 다운스트림으로 전파되는걸 방지 (비용, 노력, 기술부채 발생), 워크센터에서 새로운 일이 시작되는걸 방지(새로운 오류가 발생한다), 

* 품질 활동을 원천에 더 가깝게 유지하기 (쉽게 말하면 empower구만)

	* “누군가가 개발자에게 6개월 전에 망가뜨린 것을 두고 소리를 질러봤자 개발자는 아무것도 배울 수 없다. 몇 분 이내에 피드백을 제공해야 한다”

* 다운스트림 워크센터 최적화 하기

	* 거꾸로 놓을 수 없는 부품, 과도하게 조일 수 없는 나사

	* 아키텍처, 성능, 안정성, 테스트 가능성, 구성 가능성, 보안같은 비기능적 요구 사항도 사용자 기능만큼 높은 우선순위를 차지하도록 다운스트림 워크센터를 구성한다.

## 세번쨰 방법: 지속적인 학습과 실험 원칙

팀과 조직의 지식을 생성하기 위한 원칙

* 조직적 학습과 안전 문화 활성화

	* 병리학적 조직, 관료주의적 조직, 생성적 조직 비난 없는 포스트모템

* 일상 업무 개선을 제도화하기

	* 개선을 거부하는 사람은 존재한다. 이들에게 할 수 있는 말. “개선이 없다면, 혼란과 엔트로피로 인해 프로세스가 동일한 상태로 유지되지 않으며, 시간이 흐르면서 질적으로 저하된다.” “일상 업무의 개선은 일상 업무보다 훨씬 더 중요하다.”

* 지역적인 발견을 조직 전체의 개선으로 전환하기

	* 5700개의 원자로를 운영하는 미해군이 사고 없이 병력을 운영한 비결, 새로운 사병이 지식을 습득 할 수 있는 체계적 시스템. 모스트모템 보고서 검색 시스템, 지식이 아티펙트화되어야 한다.

* 일상 업무에 탄력성 패턴 적용

	*  인위적으로 라인에 물량을 몰아 실험하여 생산력을 올린 세이키, 나심 탈레브의 안티프레질이 이것이다.  게임데이, 카오스 몽키 모두 인위적으로 실패를 만들어 내고 그 대응을 테스트한다.

* 리더가 학습문화 강화하기

	* 리더와 팔로워는 서로 필요로 하여야 한다. 리더는 실무를 하지 않고 팔로워는 맥락과 권한이 없다.





# 2부 어디에서 시작하는가?

## 변환을 시작할 가치 흐름의 선택

**데브옵스 전환을 시작하기 위한 가치 파악**

* 그린필드 서비스 vs 브라운필드 서비스

	* 새 땅에 적용하는 프로젝트, 기존 땅에 적용하는 프로젝트

* 기록 시스템과 참여 시스템을 모두 고려하라



## 가치 흐름 내 작업의 이해 및 시각화와 조직 전체로의 확장

**목표를 달성하기 위한 조직의 구성**

* 가장 공감적이고 혁신적인 그룹에서 시작하라

	* 기술애호가, 이상주의자, 실용주의자, 보수주의자, 회의주의자 순으로 수용하는 변화. 왼쪽과 함께 시작하라.

* 데브옵스를 전체 조직으로 확장하기

“작은 물고기는 작은 연못에서 큰 물고기가 되는 법을 배운다” 

* 후보 가치 흐름에서 완료되는 작업의 이해

	* 굳이 코볼 애플리케이션을 제거하지 않아도 리드타임을 줄일 수 있다.

* 가치 흐름을 지원하는 팀 식별하기

* 업무 파악을 위한 가치 흐름 매핑 생성하기 - 가치흐름 지도 (리드타임, 부가가치 타임, %C/A [Percent complete and accurate])

* 공유된 목표에 동의하기

* 개선 계획을 위한 기간을 짧게 유지하기

	* 기능 / 결함 / 아키텍처-비기능 요구 사항-프로세스 개선 / 기술 부채 → 사용자에게 보이는 것 그리고 긍정적 부정적인것으로 본 매트릭스

	* 개선활동은 기술부채를 제거하기 위한 세금이라고 생각하면 편하다. 기술부채의 이자만 내는 상황을 모면하기 위해서 제일 중요한건 평소에 부채를 없애는것.

*링크드인의 오퍼레이션 인버전*

	* 2주에 한번 하던 업데이트를 하루에 3번 할 수 있게 만듬. 두 달 동안 모든 신규기능 개발을 중단하겠다고 말하는데는 용기가 필요했다. 

* 행동 변화를 촉진하기 위한 도구 사용

## 콘웨이의 법칙을 고려한 조직 및 아키텍쳐의 설계

* 조직의 아키타입 ( 기능중심 조직, 매트릭스 중심 조직, 시장지향적 조직)

* 과도한 기능중심(비용 최적화)으로 인한 문제

	* 기능별로 쪼개진 팀은 업무 흐름에 대한 가시성을 얻지 못하고 리드타임이 길어진다.

* 시장지향적 팀 활성화(속도 최적화)

	* 한 팀이 개발과 테스트, 보안, 배포 및 지원을 함께 한다.

* 일상 업무로 테스트, 운영, 보안 활동을 수행하라

* 모든 팀원이 제너럴 리스트가 되게 하라

	* 속도의 이익이 비용보다 크다. 교차 교육은 직원의 경력 성장을 위해 옳은 선택이며 모든 사람의 작업을 더 즐겁게 한다. 

	* 긍정적 혼란을 촉진해야 한다.

* 프로젝트가 아닌 서비스와 제품에 자금을 투자하라

* 콘웨이의 법칙에 따라 팀의 경계를 설계하라

* 개발자의 생산성과 안정성을 위해 느슨하게 결합된 아키텍처를 구축하라

* 팀 규모를 작게 유지하라 (피자 두판의 법칙)

	* SOA 서비스 기반 중심 아키텍처는 유연성과 확장성을 가지고 있다.

		* DDD 는 서비스 내부를 알지 못해도 서비스 코드를 이해하고 업데이트하는 것을 지향한다. 오직 API로만 상호작용하고 데이터 구조, 스키마, 객체의 내부 표현은 알 필요가 없다.

	* 작은 팀은 어드미니스트리비아 (조직의 비효율성을 높히는 지루하고 사소한 행정 업무)의 늪에 빠지지 않는다. 비즈니스에 배정된 각 그룹은 담당 비즈니스를 완전히 책임진다.

## 일상 업무와 운영을 통합해 최상의 결과를 얻는 방법

* 개발자의 생산성을 향상시키기 위한 공유서비스를 생성하라

	* 자체 서비스 운영 플랫폼이 없다면 클라우드는 값 비싼 호스팅 2.0에 불과하다. 

* 개발 팀 업무 활동과 운영을 통합하라

	* 개발팀 회의에 운영팀을 초대하고

	* 회고에도 초대한다.

* 관련 운영 업무를 공유 칸반 보드에 시각화하라 (왜 개발만 넣냐!)



‼️ 2부 결론 아아키텍처와 조직 설계와 관련된 측면, 팀 구성 방법을 비롯해 데브옵스 전환에 대한 다양한 방법을 살펴봤다.



# 3부 소개

**개발에서 운영으로 빠른 흐름을 만드는 아키텍처와 기술적 실천**

## 배포 파이프라인의 기반 구축

개발팀에 가장 중요한건 ‘환경의 가용성 개선’, 테스트환경이 운영환경과 유사할것.

* “올바른 환경을 조성하는데 걸리는 시간이 8주에서 1일로 단축됐다. 이것은 리드타임 등 목표를 달성하는데 핵심적 조정 사안이었다.”

* 자동화 될 수 있는 업무

	* 가상화된 환경 복사(VM이밎, Vagrant 스크립트 실행, AMI)

	* 베어메탈에서 자동화된 환경 생성(네트워크 환경부터 PXE로 리눅스 설치) 

	* IaC 형상 관리 도구

	* 자동화된 운영체제 설정도구 (Kickstart, Debian pressed)

	* 가상이미지, 컨테이너 환경(Docker)

	* 공용클라우드, PaaS 사용

* 버전관리로 관리할 자산

	* 소스, 의존성, 아티팩트, 프로젝트 아티팩트(요구사항, 배포 프로시저, 릴리스 노트), 클라우드 구성파일(cloudformation template), 테스트 스크립트, 패키징 및 마이그레이션 스크립트, 인프라 생성 스크립트

* 인프라스트럭처를 복구보다는 재구축하기 쉽게 만들어라

	* 애완견처럼 서버를 다루지말고 소 떼처럼 다루라. 아프면 총으로 쏴버려라.

	* 수동변경을 막고 변경하는 방법은 변경 내용을 버전관리에 넣고 처음부터 콬드와 환경을 다시 만드는 것이다.

	* 오래된 것은 폐기하거나 제외되어야 한다. (넷플릭스 AWS 인스턴스의 평균 수명은 24일, 60%는 1일 미만이다)

* 유사 프로덕션 환경에서의 실행도 포함하도록 개발완료의 ‘완료’ 정의를 수정하라.

	* 이렇게 함으로서 PRD 문제를 대부분 발견했다는 자신감을 가질 수 있다. 

#### 결론

* Single source of truth 가 지향점

* 이게 테스트의 자동화를 활성화하기 위한 기본 사항



## Ch10 - 신뢰 할 수 있는 자동화 테스트

- 몇 달뒤에 알게되는 버그는 최악이다.

- 두려움은 정신적 살인범이다. 새로운 팀원은 이해하지 못해서 변경하지 못하고 경험 많은 사람은 알아서 변경하지 못한다.

- GWS는 모든 검색팀의 쓰레기 처리반 이었지만 지속적인 통합 정책을 추진해 테스트커버리지를 높혀나갔다. 

- 대규모 실패의 경우 여러 엔지니어가 당신에게 연락을 할거다. 바로 수정 할 수 있어야 하고 우리는 롤백을 아주 수비게 할 수 있길 원한다.

- 지속적 빌드 테스트 통합, 신뢰도와 자동화를 확보한 테스트 스위트

	- 단위 테스트, 단일 메서드, 단위 클래스, 독립 기능을 테으슽. 외부 의존성을 스텁으로 만든다. 

	- 승인 테스트(Acceptance test). 회귀 오류를 방지하기 위한 (이전 기능을 망가트림), 설계한 스토리를 테스트, 

	- 단위 테스트의 목적이 프로그래머의 의도와 동작을 검증하는 것, 승인 테스트는 고객의 의도대로 동작하는 것을 증명.

	- 통합 테스트. App to App  상호작용을 보장

	- “10 분 이내에 단위 테스트를 마치고 승인 및 통합 테스트는 몇시간을 가정하고 초기에 잡아내는게 베스트”

- 가능한 초기에 자동화 테스트로 오류를 찾아내라

	- 큰 단위 테스트 이전에 단위 테스트에서 잡아낼 수 있도록 테스트를 구성하는게 최선

	- 이상적인 자동화 프라미드

	- 단위, 승인 테스트를 작성하고 유지하기가 어렵거나 비용이 든다면 경계가 존재하지 않는 강한 결합일 가능성이 있다. 더 느슨하게 만들어야한다는 징후

* 스위트 테스트에 성능 테스트를 통합하라

* 비기능 요구 사항 테스트를 테스트 스위트와 통합

	* 가용, 확장, 용량, 보안. IaC를 쓴다면 cucumber같은 프레임워크를 환경 테스트에 사용할 수 있다. 비즈니스와 개발의 다리를 놓는 좋은 BBD적 방법

* 안돈코드 실행

	* 신뢰성 확장 과 관련된 문제는 쇼 스토퍼급(DB를 날리는 사건에 의해 서있는 사람들) 사안으로 다룬다. 이건 실패를 방지하는 역할

## 지속적 통합

* 독립적 브랜치 작업은 좋기도 하지만 병합 난이도를 점점 올린다. 병합이 어려워지면 병합을 더 드물게 하고 더 나쁜 프로덕트의 원인이 된다. 

* HP 레이저 팀은 단 5%의 시간만 새로운 기능에 투자할 수 있었다. 

	* 낭비: 계획, 별개 코드 브랜치의 이식, 브랜치 간 통합, 수동 테스팅

	* 실행: 지속적 통합, 트렁크 기반 개발, 자동화 테스트, 하드웨어 시뮬레이터 생성, 개발자 스테이션에서 실패한 테스트 재현, 모든 프린터에 대한 일반 빌드 및 릴리즈를 위한 새로운 아키텍처

* 소규모 배치 개발과 트렁크로 드물게 커밋하면 생기는 일

	* 대규모 병합: 하나의 변경이 다른 사람에게 영향이 크다. 리팩토링도 하기 힘들게 만든다. 수정을 회피하면 결국은 가장 높은 비용을 지불하는 때가 온다.

	* 트렁크 기반으로 관리하면 커밋이 파이프라인을 망가트리는건 매번 예측하고 커밋을 거부할 수 있다. 제한된 커밋.

	* 더 많이 릴리즈 하는 대신 다크 머밋

	* 최근 연구들은 트렁크 기반 개발이 낫다고 말한다. 

```diff
+ 트렁크 기반 개발. 이런 패러다임도 있구나. 실무에서 이렇게 하는거 뭔가 잘못된거 같아 보였는데 이게 트렌디한 방법이었네..
```






## 12장 낮은 위험도의 출시 자동화와 활성화

* 배포를 수동할때 드는 번거로움이 장기적으로 배포속도를 느리게 만든다. 빠르게 만들 방법을 찾자.

* 배포 프로세스 자동화

	* 스모크 테스트를 포함한 모든 작업의 자동화 (스모크 테스트: 프로그램이 돌아가는가?, 기능은 잘 수행되는가? 정도의 사전 테스트. 이걸 통과하면 정상 테스트를 수행한다.)

* 자동화된 셀프 배포를 활성화하라. (개발과 운영의 배포 성공률은 차이가 없다)

* 배포를 배포 파이프라인과 통합하라

* 출시와 배포를 분리하라, 다크런칭, 블루-그린 배포(이중화된 서비스 중 한 개에 배포하고 나머지는 스테이징으로 관리하면서 배포된곳에 트래픽을 흘려보는 기법), 카나리아 출시클러스터 면역체계가 예시

	* 블루-그린 배포에서 데이터베이스 변경이 문제가 되는데, 데이터베이스도 블루-그린으로 나눠서 롤백시 그린도 롤백하는 방법이 있고 (트랜잭션 손실은 감안) 앱 변경과 DB변경을 구분해서 배포하는 방법도 쓸 수 있다. 후자의 경우 ‘확장과 축소’ 패턴이라 불리는데 매번 스키마를 복제해서 새로운 스키마에 앱을 쓴다. 그리고 old 데이터는 삭제.

	* 구버전과 신버전이 동시에 동작하도록 앱을 구성하는것도 방법이다. 서비스를 사용하는 사람이 업데이트 시점을 선택할 수 있다.

	* 

####  애플리케이션 기반 패턴



* 다크런치의 경우 1%의 사람만 신규 기능을 실행하되 사용자에게 보여주지 않고 결과만 저장하고 세션을 끝낼 수 있다. - 페이스북 게이트키퍼의 성공

	* 하룻밤 사이에 사용자를 0명에서 7000만명으로 늘린 비결은 하루만에 그 일을 하지 않는것이다.



## 위험도가 낮은 출시 아키텍처

#### 생산성, 테스트 용이성 및 안전성을 향상하는 아키텍처

* 모든 상황에 적합한 아키텍처는 없다.  x1, x10, x100의 상황에는 각각의 답이 존재한다.

* 마이크로 서비스를 구현하기 위해 더 많은 저장소와 정교한 도구, 의존성 관리, 더 많은 협력과 네트워크 지연을 감수한다.

#### 엔터프라이즈 아키텍처의 안전한 진화를 위한 교살자 애플리케이션 패턴

* 서비스지향 아키텍트, 그 현실의 예로서 빌딩블록으로 쪼개어 격리된 환경을 약속하고 점진적으로 기존의 모놀리식을 대체하는 것을 말함.



## 4부 두번째 방법을 위한 기술적인 실천 방법

**운영에서 개발로의 지속적인 피드백을 위한 실천**

 

### 14장 문제의 확인과 해결을 가능하게 하는 텔레메트리 생성

* 재부팅을 반복하는 조직문화는 좋지않다. 사고를 진단하는 culture of causalty가 성과의 핵심.

* 텔레메트리를 생성하는 방법은 무수히 많다. 너무 많은 정보에 운영은 정보의 Silos가 되었다.

### 16장 다운스트림 피드백을 만드는방법

* 개발 -> LPR -> 운영으로 흐름을 만들어봐라

* 개발팀에 SRE가 참여하고 사전 전검 체크리스트(LRR)와 핸드오프 체크리스트(HRR)를 활성화하여 서비스의 안정화를 도모한다.

### 17장 A/B 테스트

* 끝없이 실험을 강조하는 회사

* 모든 변화에 달러가치를 부여한다.

* 신규 기능의 1/3은 가치를 부여하고 2/3은 부여하지 않거나 저해한다. 따라서 가치를 부여하지 못한다면 그냥 휴가를 보내는게 낫다.

* 유저의 사용활동을 최상의 메트릭으로 두고 혁신을 가속화하는게 중요하다.

* AB테스트를 통해 환경을 통제한 상태에서 직원들의 개선활동이 얼마나 성과를 내는지 확인하는 것은 활동의 의미를 부여하는데 굉장히 중요하다.

### 제 18장 현재 작업 품질 증가를 위한 리뷰와 조정 프로세스 생성

* 피어리뷰와 비례하는 팀의 성과

* 변경 크기와 위험은 비선형적인 관계에 있다. 자주 통합해야하는 이유.

* 페어프로그래밍은 느린만큼 오류가 적다. 익스트림을 실천해서 얻는 학습은 보너스다.

* 5WHY 기법을 통해 일의 거버넌스를 조정하고 모든 것을 다 했다면 스스로 책임지고 배포하는 문화

# 3부 지속적 학습 및 실험에 대한 실천

### 개요

just culture(고의가 아니면 용서한다), 프로덕션에 실패주입, 지역적 발견을 전체로 전환, 준비시간

### 실패를  배움의 기회로

- 좋은 조직일 수록 더 포스트모뎀을 가속화한다. 실패를 많이 할 수록 더 견고해진다. 실패를 감당할 수 있는 상태가 될때 더 많은 배포를 할 수 있고 더 강해진다.

- 카오스몽키로 단련된 넷플릭스 직원들은 AWS 대량 리부트 사태에도 파티를 갈 수 있었다.! 가져와!

- 지속가능한 경쟁우위는 더 빨리 배우는 능력뿐이다.(…)

- 게임데이를 통해 발전기의 디젤을 개인카드로 구매할 수 밖에 없었음을. 비상사태에 누구에게 연락해야할지 알 수 있었다. 자신이 모르는것을 알게하는 것이 게임.

### 지역적 학습을 전체로 전이하기

* 채팅방과 챗봇, 공유되는 지식, 메일이 아닌 채팅, 소프트웨어의 표준 프로세스, 단일 소스 코드 저장소

* 회사 전체가 공유하는 라이브러리와 라이브러리를 지탱하는 TDD, 사용자는 테이트 수트를 보고 



---

#### 검색해볼 리스트

텔레메트리Telelmetry